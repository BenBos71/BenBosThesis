<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Feelings Survey</title>
    <link rel="stylesheet" href="../css/main.css">
    <script src="../js/main.js"></script>
    <script>
        let startTime;
        window.addEventListener('load', async function() {
            document.body.style.display = 'none';
            startTime = Date.now();
            var images = [
                "happy",
                "sad",
                "none",
            ];

            var randomIndex = Math.floor(Math.random() * images.length);
            var image_dir = images[randomIndex];

            const hcount = fetchSurveyCount('happy', sessionStorage.getItem('sex'), sessionStorage.getItem('ed_field'));
            const hapCount = sessionStorage.getItem('surveyCount');
            console.log("Happy COUNT: [" + hapCount + "]");
            console.log("Happy COUNT ret: [" + hcount + "]");

            const sCount = fetchSurveyCount('sad', sessionStorage.getItem('sex'), sessionStorage.getItem('ed_field'));
            const sadCount = sessionStorage.getItem('surveyCount');
            console.log("Sad COUNT: [" + sadCount + "]");
            console.log("Sad COUNT ret: [" + sCount + "]");
            

            const nCount = fetchSurveyCount('none', sessionStorage.getItem('sex'), sessionStorage.getItem('ed_field'));
            const nonCount = sessionStorage.getItem('surveyCount');
            console.log("None COUNT: [" + nonCount + "]");
            console.log("None COUNT ret: [" + nCount + "]");

            if (hapCount >= 30 && sadCount >= 30 && nonCount >= 30)
            {
                /* nothing */
            }
            else
            {
                image_dir = getImageDir(image_dir, hapCount, sadCount, nonCount);
            }

            if (image_dir !== "none")
            {
                document.getElementById("image_display").src = "../images/survey_images/" + image_dir + "/1.jpg";
            }
            document.getElementById("sentence").textContent = "My old cat has died and gone to the next life.";
            sessionStorage.setItem("image_dir", image_dir);

            var dropdownMenu = document.getElementById("myDropdown");
            dropdownMenu.style.display = "none";
            document.body.style.display = 'flex';
        });
    </script>
  </head>
  <body>
    <br />
    <p id="page-counter">1/35</p>
    <div class="content">
        <img id="image_display" src="" alt="" class="ind_pic"/>
        <br />
        <p id="sentence"></p>
        <br />
        <form id="demoForm" >
            <div class="dropdown">
                <p>Emotion:</p>
                <button type="button" onclick="toggleDropdown()" class="dropbtn" id="dropbtn">Click here to select an option:</button>
                <div id="myDropdown" class="dropdown-content">
                    <a href="#" id="enjoyment" onclick="selectOption('Enjoyment')">Enjoyment</a>
                    <a href="#" id="sadness" onclick="selectOption('Sadness')">Sadness</a>
                    <a href="#" id="anger" onclick="selectOption('Anger')">Anger</a>
                    <a href="#" id="contempt" onclick="selectOption('Contempt')">Contempt</a>
                    <a href="#" id="disgust" onclick="selectOption('Disgust')">Disgust</a>
                    <a href="#" id="fear" onclick="selectOption('Fear')">Fear</a>
                    <a href="#" id="surprise" onclick="selectOption('Surprise')">Surprise</a>
                </div>
            </div>
            <div>
                <p>Positive or Negative:</p>
                <div class="radio-group">
                    <input type="radio" id="positive" name="radioOption" value="positive">
                    <label for="positive">Positive</label><br>

                    <input type="radio" id="negative" name="radioOption" value="negative">
                    <label for="negative">Negative</label><br>
                </div>
            </div>
            <br>
            <input type="hidden" id="selectedOption" name="selectedOption" value="">
            <input type="submit"  value="Next" class="subButt"/>
        </form>
    </div>
    <br />
    <script type="text/javascript">
        document.getElementById('demoForm').addEventListener('submit', function(event) {
            event.preventDefault(); 
            validateForm(event);
        });

        function next(valence)
        {
            if (valence === 'positive') {
                valence = 'p';
            } else {
                valence = 'n';
            }
            sessionStorage.setItem('time1', Date.now() - startTime);
            sessionStorage.setItem('emote1_e', document.getElementById("selectedOption").value);
            sessionStorage.setItem('emote1_v', valence);
            window.location.assign('survey_2.html');
        }

        document.addEventListener('DOMContentLoaded', function() {
            const dropdown = document.getElementById('myDropdown');
            const links = Array.from(dropdown.getElementsByTagName('a'));

            // Function to shuffle the array (Fisher-Yates algorithm)
            function shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]]; // Swap
                }
                return array;
            }

            // Function to save the order of link IDs to sessionStorage
            function saveOrderToSessionStorage(order) {
                const linkIds = order.map(link => link.id);
                sessionStorage.setItem('dropdownOrder', JSON.stringify(linkIds));
            }

            // Function to load the order from sessionStorage
            function loadOrderFromSessionStorage() {
                const storedOrder = sessionStorage.getItem('dropdownOrder');
                if (storedOrder) {
                    const linkIds = JSON.parse(storedOrder);
                    return linkIds.map(id => document.getElementById(id));
                }
                return null;
            }

            // Check if we have an order stored in sessionStorage
            let orderedLinks = loadOrderFromSessionStorage();

            if (!orderedLinks) {
                // If no order is stored, shuffle the links and save the order
                orderedLinks = shuffleArray(links);
                saveOrderToSessionStorage(orderedLinks);
                processStoredOrder();
            }

            // Append the links in the saved or shuffled order
            orderedLinks.forEach(link => dropdown.appendChild(link));
        });

        function processStoredOrder() {
            let emotOrdr = "";
            const storedOrder = sessionStorage.getItem('dropdownOrder');
            
            if (storedOrder) {
                const linkIds = JSON.parse(storedOrder);

                // Loop through each stored link ID and process it
                linkIds.forEach(function(id, index) {
                    const linkElement = document.getElementById(id);
                    if (linkElement) {
                        const linkText = linkElement.textContent.trim(); // Get the text content of the link

                        // Conditional logic based on the link text
                        if (linkText === "Anger") {
                            emotOrdr += 'a';
                        } else if (linkText === "Contempt") {
                            emotOrdr += 'c';
                        } else if (linkText === "Disgust") {
                            emotOrdr += 'd';
                        } else if (linkText === "Enjoyment") {
                            emotOrdr += 'e';
                        } else if (linkText === "Fear") {
                            emotOrdr += 'f';
                        } else if (linkText === "Surprise") {
                            emotOrdr += 'p';
                        } else if (linkText === "Sadness") {
                            emotOrdr += 's';
                        } 
                    }
                });
            } else {
                console.log('No order is stored in sessionStorage.');
            }

            sessionStorage.setItem('emotOrdr', emotOrdr);
        }


    </script>
  </body>
</html>