<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>CinSandE</title>
    <link rel="stylesheet" href="../css/main.css">
    <script>
        window.addEventListener('load', function() {
            var imageDir = sessionStorage.getItem("image_dir");

            // Check if the value is not "none"
            if (imageDir !== "none") {
                // Update the src attribute of the image element
                document.getElementById("image_display").src = "../images/survey_images/" + imageDir + 
                "/35.jpg";
            }
            document.getElementById("sentence").textContent = "By the tranquil lake, beneath the setting sun.";

            // Get dropdown var
            var dropdownMenu = document.getElementById("myDropdown");
            dropdownMenu.style.display = "none";
        });
    </script>
</head>
<body>
    <img src="../images/wsuLogo.png" alt="Weber State University Logo" class="logo"/>
    <br />
    <div class="content">
        <img id="image_display" src="" alt="" class="ind_pic"/>
        <br />
        <p id="sentence"></p>
        <br />
        <form id="demoForm">
            <div class="dropdown">
                <button type="button" onclick="toggleDropdown()" class="dropbtn" id="dropbtn">Select an option:</button>
                <div id="myDropdown" class="dropdown-content">
                    <a href="#" onclick="selectOption('Happy')">Happy</a>
                    <a href="#" onclick="selectOption('Sad')">Sad</a>
                </div>
            </div>
            <input type="hidden" id="selectedOption" name="selectedOption" value="">
            <input type="submit"  value="Submit"/>
        </form>
    </div>
    <br />
    <script type="text/javascript">
        document.getElementById('demoForm').addEventListener('submit', function(event) {
            event.preventDefault(); // Prevent form from submitting the traditional way
            validateForm(event); // Call the validation function
        });

        function toggleDropdown() {
            var dropdownMenu = document.getElementById("myDropdown");
            if (dropdownMenu.style.display === "none") {
                dropdownMenu.style.display = "block";
            }
            else {
                dropdownMenu.style.display = "none";
            }
        }

        function selectOption(optionText) {
            var dropdownButton = document.getElementById("dropbtn");
            dropdownButton.textContent = optionText;

            var dropdownMenu = document.getElementById("myDropdown");
            dropdownMenu.style.display = "none"; 
            
            document.getElementById("selectedOption").value = optionText;
        }

        function validateForm(event) {
            var selectedOption = document.getElementById("selectedOption").value;
            if (!selectedOption) {
                alert("Please select an option from the dropdown.");
                event.preventDefault();
            }
            else {
                if (sessionStorage.getItem('formSubmit') === 'false')
                {
                    next();
                }
                else
                {
                    alert("Thank you for completing the survey!  You may now close this window.");
                }
            }
        }

        window.onclick = function(event) {
            if (!event.target.matches('.dropbtn')) {
                var dropdowns = document.getElementsByClassName("dropdown-content");
                for (var i = 0; i < dropdowns.length; i++) {
                    var openDropdown = dropdowns[i];
                    if (openDropdown.style.display === "block") {
                        openDropdown.style.display = "none";
                    }
                }
            }
        }

        function next() {
            let emotions = [];
            emotions.push(sessionStorage.getItem('sAge'));
            emotions.push(sessionStorage.getItem('sSex'));
            emotions.push(sessionStorage.getItem('image_dir'));
            emotions.push(sessionStorage.getItem('emote1'));
            emotions.push(sessionStorage.getItem('emote2'));
            emotions.push(sessionStorage.getItem('emote3'));
            emotions.push(sessionStorage.getItem('emote4'));
            emotions.push(sessionStorage.getItem('emote5'));
            emotions.push(sessionStorage.getItem('emote6'));
            emotions.push(sessionStorage.getItem('emote7'));
            emotions.push(sessionStorage.getItem('emote8'));
            emotions.push(sessionStorage.getItem('emote9'));
            emotions.push(sessionStorage.getItem('emote10'));
            emotions.push(sessionStorage.getItem('emote11'));
            emotions.push(sessionStorage.getItem('emote12'));
            emotions.push(sessionStorage.getItem('emote13'));
            emotions.push(sessionStorage.getItem('emote14'));
            emotions.push(sessionStorage.getItem('emote15'));
            emotions.push(sessionStorage.getItem('emote16'));
            emotions.push(sessionStorage.getItem('emote17'));
            emotions.push(sessionStorage.getItem('emote18'));
            emotions.push(sessionStorage.getItem('emote19'));
            emotions.push(sessionStorage.getItem('emote20'));
            emotions.push(sessionStorage.getItem('emote21'));
            emotions.push(sessionStorage.getItem('emote22'));
            emotions.push(sessionStorage.getItem('emote23'));
            emotions.push(sessionStorage.getItem('emote24'));
            emotions.push(sessionStorage.getItem('emote25'));
            emotions.push(sessionStorage.getItem('emote26'));
            emotions.push(sessionStorage.getItem('emote27'));
            emotions.push(sessionStorage.getItem('emote28'));
            emotions.push(sessionStorage.getItem('emote29'));
            emotions.push(sessionStorage.getItem('emote30'));
            emotions.push(sessionStorage.getItem('emote31'));
            emotions.push(sessionStorage.getItem('emote32'));
            emotions.push(sessionStorage.getItem('emote33'));
            emotions.push(sessionStorage.getItem('emote34'));
            emotions.push(document.getElementById("selectedOption").value);
            
            console.log('Emotions array:', emotions); // Log the emotions array

            fetch('https://fierce-escarpment-41876-06bb2cc451d1.herokuapp.com/submit-form', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ surveyResults: emotions }),
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Server response:', data);
                alert("Thank you for completing the survey!  You may now close this window.");
            })
            .catch(error => {
                console.error('Fetch error:', error);
            });
        }
    </script>
</body>
</html>
